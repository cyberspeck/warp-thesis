

\chapter{Material and methods}

%  Everything that is mentioned in results, has to be mentioned here
%  Everybody who reads thesis, must be able to reproduce the experiment/study
% o Describe all materials, devices and methods, which were used in your work
% o if you describe a device, start with the brand name followed by the company name, city and country in parentheses: e.g. "... a VersaHD (Elekta AB, Stockholm, Sweden) was used in ...".
% o Provide some information on each device
%  e.g Linac, which energies were used, what was the field size, what was the leaf width, how is the linac calibrated, ...;
%  e.g. Detector array: which type of detector, how many detectors, what is the resolution, energy dependence, linearity,...;
%  e.g. Panning systems: software version, algorithms, settings used in this study
%  e.g. software: version, functionality
% o Also describe used data (patient cohort) even if they were taken from other studies

\section{Scanners}

The radiation oncology department of the Vienna General Hospital (AKH) owns a open-bore, c-arm MRI scanner and a CT scanner (used as reference).
They are listed in Table \ref{tab:scanners}.

\begin{table}[h]
\centering
\begin{tabular}{llll}
System	& product name	& company	& coil [internal W x H]		\\
\toprule
MRI	& Magnetom C!	& Siemens	& Body/Spine Array Coil XL	\\
	&		&		& [50 x 30.5 cm (19.7 x 12 in)]	\\
CT	&		&		& --------
\end{tabular}
\caption{used scanners}
\label{tab:scanners}
\end{table}

\subsection{MRI scanner - field distribution}

The Magnetom C! MRI scanner comes with a handbook which contains diagrams of the magnetic field strength (fig. \ref{fig:strength_side}), and its gradient (fig. \ref{fig:gradient_side}, \ref{fig:gradient_top}, and  \ref{fig:gradient_front}).
Figure \ref{fig:scanner} shows an image and different views of the scanner and the planes along which the field strength and gradient are displayed.

\begin{figure}[!htb]
\centering
  \begin{subfigure}[b]{0.4\textwidth}
	\centering
	\includegraphics[scale=0.7]{scanner/scanner_img.jpg}
	\caption{Image of scanner\\ x,y, \& z -axis}
	\label{fig:scanner_image}
  \end{subfigure}
    \hfill
  \begin{subfigure}[b]{0.4\textwidth}
  	\centering
    \includegraphics[scale=0.7]{scanner/scanner_front.jpg}
    \caption{side view along z-axis,\\ black line represents plane for front view (see fig. \ref{fig:gradient_front})}
    \label{fig:scanner_front}
  \end{subfigure}
  
  \begin{subfigure}[b]{0.4\textwidth}
   	\centering
   	\includegraphics[scale=0.7]{scanner/scanner_top.jpg}
   	\caption{front view along x-axis,\\ black line represents plane for top view (see fig. \ref{fig:gradient_top})}
   	\label{fig:scanner_top}
  \end{subfigure}
    \hfill
  \begin{subfigure}[b]{0.4\textwidth}
  	\centering
  	\includegraphics[scale=0.7]{scanner/scanner_side.jpg}
  	\caption{front view along x-axis,\\ black line represents plane for side view (see fig. \ref{fig:gradient_side} and \ref{fig:strength_side})}
  	\label{fig:scanner_side}
  \end{subfigure}
  \caption{Magnetom C! \cite{magnetom_handbook}}
  \label{fig:scanner}
\end{figure}

%diagrams as individual figures:
\begin{figure}[!htb]
  	\centering
      \includegraphics[scale=1.1]{scanner/scanner_field-strength.jpg}
      \caption{Magnetom C! field strength\\ side view along z-axis (see fig. \ref{fig:scanner_side}) \cite{magnetom_handbook}}
    \label{fig:strength_side}
\end{figure}

\begin{figure}[!htb]
    	\centering
        \includegraphics[scale=1.1]{scanner/scanner_gradient-side.jpg}
        \caption{Magnetom C! field gradient\\ side view along z-axis (see fig. \ref{fig:scanner_side}) \cite{magnetom_handbook}}
        \label{fig:gradient_side}
\end{figure}

\begin{figure}[!htb]
  	\centering
    \includegraphics[scale=1.1]{scanner/scanner_gradient-front.jpg}
    \caption{Magnetom C! field gradient\\ front view along x-axis (see fig. \ref{fig:scanner_front}) \cite{magnetom_handbook}}
    \label{fig:gradient_front}
    \end{figure}

\begin{figure}[!htb]
  	\centering
    \includegraphics[scale=1.1]{scanner/scanner_gradient-top.jpg}
    \caption{Magnetom C! field gradient\\ top view along y-axis (see fig. \ref{fig:scanner_top}) \cite{magnetom_handbook}}
    \label{fig:gradient_top}
\end{figure}


% diagrams as sets of subfigures:
%\begin{figure}[!htb]
%\centering
%  \begin{subfigure}[b]{\textwidth}
%  	\centering
%    \includegraphics[scale=1]{scanner/scanner_gradient-front.jpg}
%    \caption{field gradient - front view (see fig. \ref{fig:scanner_front})}
%    \label{fig:gradient_front}
%  \end{subfigure}
%  \begin{subfigure}[b]{\textwidth}
%  	\centering
%    \includegraphics[scale=1]{scanner/scanner_gradient-top.jpg}
%    \caption{view along y-axis,\\ field gradient - top view (see fig. \ref{fig:scanner_top})}
%    \label{fig:gradient_top}
%  \end{subfigure}
%  \caption{Magnetom C! field gradient}
%  \label{fig:scanner}
%\end{figure}
%
%\begin{figure}[!htb]
%\centering
%  \begin{subfigure}[b]{\textwidth}
%    	\centering
%        \includegraphics[scale=1]{scanner/scanner_gradient-side.jpg}
%        \caption{field gradient}
%        \label{fig:gradient_side}
%  \end{subfigure}
%  \begin{subfigure}[b]{\textwidth}
%  	\centering
%      \includegraphics[scale=1]{scanner/scanner_field-strength.jpg}
%      \caption{field strength}
%    \label{fig:strength_side}
%  \end{subfigure}
%  \caption{Magnetom C! field gradient and strength - side view (see fig. \ref{fig:scanner_side})}
%  \label{fig:scanner_gradient}
%\end{figure}


\section{Custom build phantom}

To compare images from different scanners and asses occurring distortion, a rigid object with known dimensions is necessary.
Such a 'phantom' is often made from plastics containing a liquid.
The AKH's design is made up from an array of replaceable, fillable plastic rods.

\begin{figure}[!htb]
\centering
  \begin{subfigure}[b]{0.1\textwidth}
    \includegraphics[scale=1]{slicer3D/full_phantom/sagittal_comparison_mr.png}
    \caption{MR}
    \label{fig:sagittal_comparison_mr}
  \end{subfigure}
  \begin{subfigure}[b]{0.1\textwidth}
    \includegraphics[scale=1]{slicer3D/full_phantom/sagittal_comparison_ct_empty.png}
    \caption{CT}
    \label{fig:sagittal_comparison_ct_empty}
  \end{subfigure}
  \begin{subfigure}[b]{0.1\textwidth}
    \includegraphics[scale=1]{slicer3D/full_phantom/sagittal_comparison_ct.png}
    \caption{CT}
    \label{fig:sagittal_comparison_ct}
  \end{subfigure}
  \caption{Comparison: MRI only shows liquid filling, CT also the plastic rod and pane (horizontal black bar crossing middle and right rod);\\ (\textbf{a:}) \textit{MRI} - filled rod, plastic not visible (field of view too small to show entire rod); (\textbf{b:}) \textit{CT} - empty rod, plastic visible; (\textbf{c:}) \textit{CT} - filled rod, plastic and filling visible}
  \label{fig:sagittal_comparison}
\end{figure}

\subsection{Frame and rods}

The phantom was build to fit the largest available rigid coil for the MRI scanner.
Three parallel acrylic glass panes in the shape of the coil serve as a frame for the plastic rods.
In the middle an empty area was reserved for an optional additional smaller phantom (not used for this work).
Figure \ref{fig:phantom_photo} shows a picture of the phantom. See also figure \ref{fig:axial_CT_pane} showing a CT image of one pane (with no rods inserted). \\
More than 300 plastic rods (length: 50cm, outer diameter: 8mm, inner diameter: 4mm, volume: approx. 6mL) could be placed in the phantom.
See figure \ref{fig:rod_schematic} for a schematic sketch of one rod.
The bottom part of each rod was sealed with a hot glued plastic plug, the top could be closed with a plastic screw.
Frame and rods were already build and assembled before the author started working on this project.


% photo of phantom

\begin{figure}[!tbp]
\centering
\includegraphics[width=\textwidth]{slicer3D/full_phantom/axial_CT_pane.png}
\caption{plastic pane, no rods inserted}
\label{fig:axial_CT_pane}
\end{figure}

\begin{figure}[!tbp]
\centering
\includegraphics[width=0.8\textwidth]{slicer3D/full_phantom/rod_schematic.png}
\caption{empty plastic rod, schematic (not true proportions); }
\label{fig:rod_schematic}
\end{figure}

\vspace{4cm}
\textit{photo of Phantom}
\vspace{2cm}
\vspace{4cm}
\textit{photo of single rod}
\vspace{2cm}

\subsection{Rod fillings}

For this study 17 different liquids were produced to be tested as possible fillings.
They are listed in Table \ref{tab:solutions}.


\begin{table}[!hbt]
\centering
\begin{tabular}{@{}l|rrrrrr@{}}
No.   & $NaCl$   & $CuSO_4\cdot5H_2O$          & Soap & Ascorbic Acid & Agar & Primovist [volume-\%]\\
\toprule
\#1  &             &                   &      &               &           &		\\
\#2  & 3.6         & 1.96              &      &               &           &		\\
\#3  & 3.6         & 3.92              &      &               &           &		\\
\#4  & 3.6         & 19.6              &      &               &           &		\\
\#5  & 3.6         & 1.96              & 1    &               &           &		\\
\#6  & 3.6         & 1.96              & 5    &               &           &		\\
\#7  & 3.6         & 1.96              & 20   &               &           &		\\
\#8  & 3.6         & 1.96              &      & 0.36          &           &		\\
\#9  & 3.6         & 1.96              &      & 3.6           &           &		\\
\#10 & 3.6         & 1.96              &      & 36            &           &		\\
\#11 & 3.6         &                   &      &               &           & 0.1\%	\\
\#12 & 3.6         &                   &      &               &           & 1\%		\\
\#13 & 3.6         &                   &      &               &           & 10\%	\\
\#14 & 3.6         & 1.96              &      &               &  0.5      &		\\
\#15 & 3.6         & 1.96              &      &               &   20      &		\\
\midrule
\#16 & \multicolumn{2}{r}{Motor Oil:}   & \multicolumn{4}{l}{\textit{Castrol Power1}}      \\
\#17 & \multicolumn{2}{r}{Silicon Oil:} & \multicolumn{4}{l}{\textit{Charge: 15HLVY023}}   \\ \bottomrule
\end{tabular}
\caption{composition of tested solutions\\(components in $g/L$; exception: Primovist in volume-\%)}
\label{tab:solutions}
\end{table}

\newpage
\begin{enumerate}[label=\textbf{\#\arabic*}]
 \item \textit{distilled water}
 \item $NaCl$ + $CuSO_4\cdot5H_2O$
 \item increased concentration of $CuSO_4\cdot5H_2O$
 \item further increased concentration of $CuSO_4\cdot5H_2O$
 \item generic washing-up \textit{soap} added to \textbf{\#2}
 \item increased \textit{soap} concentration
 \item further increased \textit{soap} concentration
 \item \textit{ascorbic acid} added to \textbf{\#2}
 \item increased \textit{ascorbic acid} concentration
 \item further increased \textit{ascorbic acid} concentration
 \item \textit{Primovist}
 \item increased amount of \textit{Primovist}
 \item further increased amount of \textit{Primovist}
 \item \textit{agar}
 \item increased \textit{agar} concentration
 \item synthetic motor oil
 \item silicon oil
\end{enumerate}

% why those solutions??

Being closed at one end and having a capillary shape (small diameter) makes it impossible for the rods to be filled by pouring in the liquid.
Instead of adding the fluid at the top, it has to be injected starting at the bottom.
This way the contained air would be pushed out by the injected liquid through the opening at the top.
A thin plastic tube was inserted and used for injection, leaving enough room for the gas to escape.
Between injections of different liquids, the tube was flushed with \textbf{\#1} (distilled water) or \textbf{\#2} (main component of most solutions).

In order to minimise the amount of gas dissolved, the liquids were brought to boil shortly before injecting. Gas solubility generally decreases with rising temperature \cite{Henry1803, Sander2015}.
After injecting the solution in the rods, they were left to cool down.
Before closing, the rods were topped up completely (no trapped air bubbles).
The oil based liquids, \textbf{\#16} and \textbf{\#17}, were not brought to boil.
Number \textbf{\#14} could be injected without problems, the solution remained fluid even after reaching room temperature.
Number \textbf{\#15} on the other hand changed to a gel like consistence and clogged the tube right after the rod was filled. The tube could not be used again.



\section{Sequences}
\todo{elaborate!}
Following the suggestions given in the Report of AAPM MR Subcommittee TG1 ``MR Acceptance Testing and
Quality Control'' \cite{Jackson2009}, T1 weighted sequences were chosen to evaluate the possible solutions. (Table \ref{tab:settings})

\begin{table}[h]
\centering
\begin{tabular}{@{}lllll@{}}
System & ---  & --- &  --- & --- \\
\toprule
MRI    & -   & -   & -   & -    \\
CT     & -   & -   & -   &
\end{tabular}
\caption{used sequences}
\label{tab:settings}
\end{table}

\section{Developed software tool}
% conda create --name snowflakes python=2.7 SimpleITK Spyder
% source activate snowflakes
% spyder

In order to asses the distortion of the MRI scanner, a tool was programmed.
It is written in Python 2.7 and uses the \textit{SimpleITK} package to read and process \textit{DICOM} (``\textit{Digital Imaging and Communications in Medicine}'') files. \cite{Python, DICOM}
\textit{SimpleITK} is a object-oriented ``C++ library with wrappers for Python, Java, CSharp, R, Tcl and Ruby''. \cite{SimpleITK, SimpleITK_started} It's versatility is one of the reasons why this approach was favoured.
It is a simplified layer built on top of the National Library of Medicine Insight Segmentation and Registration Toolkit (ITK). SimpleITK is also used by Applications like \textit{3D Slicer} , a ``free and open source software package for
visualisation and medical image computing''. \cite{3DSlicer, Kikinis2012} For this work 3D Slicer was used to crop images, quickly read values and visualise the results.
Documentation and code examples of SimpleITK can be found at \cite{InsightSoftwareConsortium, Kyriakou-SimpleITK}
An alternative way to handle DICOM data in Python would be Pydicom. \cite{Pydicom, Kyriakou-Pydicom-VTK} 

An extensive list of packages used to process data:
\begin{itemize}
 \item SimpleITK
 \item numpy
 \item scipy
 \item matplotlib.pyplot \cite{Hunter2007}
 \item skimage.draw
 \item datetime
 \item os
\end{itemize}

\subsection{Processing MRI and CT scans}

% what application used to align CT and MRI
Prior to analysing their data, the scans had to be prepared.
Figure \ref{fig:data_prep} gives an impression how the steps performed affected the data.

\begin{enumerate}[label=\textbf{Step \arabic*}]
\item To start with, they were aligned in a way that yields maximum overlap especially in the centre of the image using \textit{MIRADA}.
\item However, the MRI image had a lower resolution than the CT scan.
Therefore, the MRI voxel's size were changed to match the CT voxels. Both images were resampled to CT resolution and exported using \textit{MIRADA}.
\item Both layers (MRI and CT) were loaded into \textit{3D Slicer} (Version: Slicer-4.5.0-1-linux-amd64)
\item Its module 'annotations' was used to set a new region of interest (ROI) to include only a single rod.
\item With the module called 'crop volume' (setting: voxel based cropping) the scans were reduced to show only the selected ROI.
\item Using the module 'resample scalar volume' a number of interpolated (setting: nearest neighbour) higher resolution copies were created.
\item All data sets and the cropped original CT/MRI images were exported with 'create a dicom series' and saved in separate folders.
\end{enumerate}

\begin{figure}[!tbp]
\centering
\includegraphics[width=0.8\textwidth]{algorithm/data_prep.jpg}
\caption{Steps performed before analysing data with script}
\label{fig:data_prep}
\end{figure}

After this procedure a number of data sets based on the original CT and MRI was available, which all had the same number of slices along the z-axis parallel to the phantom's rods.
Each pair (CT+MRI) has the same pixel spacing (/resolution) in x and y direction.
See table \ref{tab:spacing} for more details.
Figure \ref{fig:resample} depicts 3 CT/MRI scans of a single rod (axial) with different resolutions.
``x1'' stands for the original CT scan resolution (MRI resampled to match).
``x4'' is a resolution resulting in 1 pixel being split in 4 smaller pixels, ``x9'' in 9, and so on and so forth.
For better visibility, images shown as figures in this work are printed with inverted colours.
Dark pixels have a high density/intensity value, white pixels are equivalent to air (low density/intensity).

\begin{table}[!htb]
\centering
\begin{tabular}{l|l|l|l}
resample factor  & z (not affected) &  y (same as x) & x \\
\toprule
x1     & 0.60 & 0.98	& 0.98	\\
x4     & 0.60 & 0.49	& 0.49	\\
x9     & 0.60 & 0.33	& 0.33	\\
% x16    & 0.60 & 0.244	& 0.24	\\
x25    & 0.60 & 0.2 	& 0.2	\\
x100   & 0.60 & 0.2 	& 0.1
\end{tabular}
\caption{pixel Spacing (rounded values) [$mm$]}
\label{tab:spacing}
\end{table}


\begin{figure}[!thb]
  \begin{subfigure}[b]{0.32\textwidth}
    \includegraphics[scale=.11]{slicer3D/profiles/CT_x1.png}
    \caption{CT x1}
    \label{fig:CT_x1}
  \end{subfigure}
  \hfill
  \begin{subfigure}[b]{0.32\textwidth}
    \includegraphics[scale=.11]{slicer3D/profiles/CT_x9.png}
    \caption{CT x9}
    \label{fig:CT_x9}
  \end{subfigure}
    \hfill
  \begin{subfigure}[b]{0.32\textwidth}
    \includegraphics[scale=.11]{slicer3D/profiles/CT_x100.png}
    \caption{CT x100}
    \label{fig:CT_x100}
  \end{subfigure}
  \begin{subfigure}[b]{0.32\textwidth}
    \includegraphics[scale=.11]{slicer3D/profiles/MR_x1.png}
    \caption{MRI x1}
    \label{fig:MRI_x1}
  \end{subfigure}
  \hfill
  \begin{subfigure}[b]{0.32\textwidth}
    \includegraphics[scale=.11]{slicer3D/profiles/MR_x9.png}
    \caption{MRI x9}
    \label{fig:MRI_x9}
  \end{subfigure}
    \hfill
  \begin{subfigure}[b]{0.32\textwidth}
    \includegraphics[scale=.11]{slicer3D/profiles/MR_x100.png}
    \caption{MRI x100}
    \label{fig:MRI_x100}
  \end{subfigure}
  \caption{CT/MRI: axial image of single rod, filling \#5  (inverted colours)}
  \label{fig:resample}
\end{figure}
\clearpage


\subsection{Capabilities}

The developed software tool is not able to automatically detect individual rods shown in a CT or MRI scan.
Instead the acquired 3D images have to be cropped to depict only a single rod.

The python script can:
\begin{itemize}
 \item denoise the image data
 \item accepts coordinates to be used as seeds, enabling it to separate bright areas which are not connected ('masking' might be used as future method to automatically detect individual rods
 \item calculate the centroid coordinates along the rod, used to
 \item measure the local distortion
  \subitem location shift
  \subitem dice coefficient (roundness/deformation)
 \item plot individual rod slices
  \subitem overlaying one or two centroid coordinates
  \subitem and save it as ``.png'' file
 \item change the pixel values to reflect the distortion occurring along a rod (visualisation)
 \item write the calculated numbers to a ``.txt'' file
\end{itemize}

\subsection{Measuring distortion}

Two phenomena were chosen to reflect the amount of distortion occurring in MRI scans:

\begin{enumerate}[label=\textbf{\arabic*)}]
 \item location shift (``warp'')
 \item deformation (deviation from circular profile ``DC'')
\end{enumerate}

Since the rods have a cylindrical shape, distortion can only be assessed in radial direction.
To make calculations easier, the z-coordinate was put parallel to the rods, x and y radial.
Ideally, each slice (z = const.) should depict the bright circular profile of the liquid (+ plastic rod in CT) surrounded by black (air).
To calculate the location shift between rods shown in CT and MRI, the coordinates of the centre of mass (COM) were subtracted.
The location difference in each slice is saved as an array.
Additionally, the absolute value of the coordinate shift (warpMagnitude) could be calculated.

% image of COM shift

The dice-coefficient ``DC'' (also known as Sorensen-Index) was chosen as indicator for the deviation from a circular profile. Again this value was calculated for every slice using either the CT or MRI scans.

To get a idea of the occurring distortion one should look at both the absolute value of coordinate shift and the dice-coefficient (DC).
The DC ranges from 0 to 1. A value of 1 indicates a perfect circular shape. A low DC on the other hand could be caused by many things such as:
little overlap (e.g. a ring or crescent shape); a very dark image hindering delineation of rod from background; a small circle with a radius close to a only a few pixels.


% A proposed third indicator combining warp magnitude and the DC:
% $warpDC = warpMagnitude * (1-DC)$

\subsection{Calculation: dice-coefficient (DC)}

The dice coefficient or Sorensen index \cite{MedPy_dc-doc} is defined as:

\begin{align}
DC = \frac{2 |A \, \cap \, B|}{|A| + |B|}
\end{align}

The implementation into python is based on the open source python package ``Medpy''. \cite{MedPy} A part of it's module called ``metric'' was adapted. \cite{MedPy_dc-code}
All pixels above a certain threshold will be counted as input A. The reference B is a circle whose midpoint is placed at the centre of mass (COM).

The calculation of the DC is done by comparing an binary image to a circle. The position of the circle's centre and its radius is highly influencing the outcome.
Both the circle's centre and its radius were varied during the distortion assessment.


\subsection{Calculation: center of mass (COM)}

The calculation of the COM is done with help of the ``scipy'' python package.
It's module ``ndimage'' contains the function ``$center\_of\_mass()$'', which returns the COM's coordinates of a given input array.
The values assigned to voxels in CT images lie in the range from -1024 HU (air) to around 200 HU (plastic rod).
Before a meaningful result can be obtained, the values need to be shifted to be $>$ 0.
Additionally, only pixels representing the rod or the liquid should be used for the calculation.
Otherwise the almost black voxels surrounding the rod would influence the result.
This error could be observed especially if the rod is not placed in the exact middle of the scan.
As described earlier, the plastic rod is only visible in CT images. On the MRI scans solely the liquid containded in the rods is shown.
Therefore, rods appear to be smaller on the MRI data.
To find the relevant pixels two algorithms were developed:

\begin{description}
 \item[1] calculating the number of pixels based on rod size
 \item[2] finding a COM resulting in good DC
\end{description}

\textit{\textbf{add 1:}}
The inner ($4mm$) and outer ($8mm$) diameter of the rods are known. So is the \textit{pixel spacing} which represents the equivalent size of a voxel in $mm$.
Calculating the number of pixels which make up the more or less circular profile of the rod in each slice is calculated as follows:

\begin{align}
 pixelNumber = (radius^2 \cdot \pi) \, / \, (spacing^2)
\end{align}

For CT images $radius = 4mm$, in MRI scans $radius = 2mm$. $spacing$ is the pixel spacing in x and y direction.
Next the pixels are sorted by brightness. The top $pixelNumber$ pixels are then used to calculate the COM.

\textit{\textbf{add 2:}}
This algorithm is an iteration method.
First it looks at the whole range of possible pixelNumbers, from $0\%$ to $100\%$.
It starts off by assuming that $50\%$ is a reasonable guess for the number of pixels that show the rod and calculates the corresponding DC value.
To find out whether more or less pixels would result in a better DC, it chooses two new guesses:
One halfway from the lower limit ($0\%$) to its current guess ($50\%$) which is:

\begin{align}
 \frac{0+50}{2}=25\% 
\end{align}

and one halfway from the upper limit ($100\%$) to its current guess ($50\%$) which is:
 
\begin{align}
 \frac{100+50}{2}=75\%
\end{align}
 
Now the corresponding DC values are calculated and compared.
If the lower percentage yields a better DC, the upper half of the range will be neglected in the next iteration, the upper limit becomes the former guess ($50\%$).
If the higher percentage yields a better DC, the lower half of the range will be neglected in the next iteration, the lower limit becomes the former guess ($50\%$).

Now in the second iteration, the range has become smaller and the next guess will be set to be exactly in the middle.
If, for example, the DC for $25\%$ was higher, the next guess will be $25\%$, because the new range goes from $0\%$ to $50\%$.
In that case, DC values for the lower half of the range ($12,5\%$) and the upper half ($18,5\%$) will be calculated and compared.
If, for example, the DC for $18,5\%$ was higher, the next guess will then be $18,5\%$, because the new range goes from $25\%$ to $50\%$.
The iteration continues until new steps yield no better DCs or a set number of steps has been performed.

After the iteration process, the algorithm will return the COM which resulted in the best DC.
Figure \ref{fig:COM_iteration} shows the DC values found in the course of the iteration method
Figure \ref{fig:COM_iteration_flow} summarises the algorithm.

\todo{flowchart for algorithms (send handwritten draft to Piotr)}
\clearpage

\begin{figure}[!thb]
  \begin{subfigure}[b]{1\textwidth}
    \includegraphics[scale=0.7]{python/iteration_COM/CT_x100_iteration_COM.png}
    \caption{CT x100, (4 steps lead to best result)}
    \label{fig:CT_x100_iteration}
  \end{subfigure}
  \begin{subfigure}[b]{1\textwidth}
    \includegraphics[scale=0.7]{python/iteration_COM/MR_x100_iteration_COM.png}
     \caption{MR x100, (15 step performed)}
     \label{fig:MR_x100_iteration}
  \end{subfigure}
  \caption{COM iteration method}
  \label{fig:COM_iteration}
\end{figure}

% image of COM shift